<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>rust gameboy emulator | timpieces</title><meta name=description content="Tim's projects, endeavours, and writing."><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=stylesheet href=/css/main.min.fb823adf578d1eef5a3d2e7ab8dd6636c9868cfd402a9ab5a4501f1c04cad268.css integrity="sha256-+4I631eNHu9aPS56uN1mNsmGjP1AKpq1pFAfHATK0mg="></head><body><header class=site-header><div class=site-header__inner><a class=site-title href=/>timpieces</a><nav class=site-nav><ul><li><a href=/blog/>Blog</a></li><li><a href=/endeavours/>Endeavours</a></li><li><a href=/about/>About</a></li></ul></nav></div></header><main class=site-main><article class=page><header class=page__header><p class=page__meta>01 Dec 2022</p></header><div class=page__body><p>A confluence of factors led me to build a gameboy emulator in rust:</p><ul><li>I had some time off during 2022.</li><li>I felt motivated to learn rust. I was a professional C++ developer and learning rust felt like it would broaden my core skillset.</li><li>I&rsquo;ve always been fascinated by emulators.</li><li>I have very fond memories of playing pokemon blue as a child.</li></ul><p>I hadn&rsquo;t written an emulator before, but the idea seemed mostly simply in principle. The great thing about the gameboy is how well documented it is. I remember using a combination of sources for the documentation but otherwise it was quite straightforward.
The goal was singular, to the to the point where I could play a full game of pokemon blue in the emulator. This meant that really all I needed was controls and the video display (i.e. no audio).
A lot of the time that went into this was:</p><ul><li>learning rust idioms</li><li>implementing the large number of opcodes, the memory management unit, and the display</li><li>debugging</li></ul><p>The debugging in particular was quite tricky. There are many opcodes and writing a test for each one is quite cumbersome. I believe there are some test harnesses out there, but I didn&rsquo;t use them. If you have an issue with only one instruction, then your emulated CPU can be executing, but nothing may be happening and it&rsquo;s near-impossible to trace it back to the exact issue.
Part of the issue here was two-fold:</p><ul><li>I took a wrong turn by modelling the CPU one-level too detailed. I created a sort of &lsquo;microcode&rsquo; in the interests of getting cycle accurate emulation, but realised later on that I wasn&rsquo;t actually going to pursue this fully, so it was just unnecessary complexity. Not having built an emulator before I didn&rsquo;t have a good intuition for how accurate the emulator must be for games to function.</li><li>I wasn&rsquo;t very familiar with when to use which rust tools for abstraction. The opcodes are an interesting mix of largely similar but subtly different, and familiarity with the language&rsquo;s features for abstraction here is very useful. It definitely hurt spending so much time iterating on the most productive way to express all of the opcodes.</li></ul><p>After a few weeks (perhaps a month) of work I achieved my goal:
<img src=./pokemon_title.png alt=title>
<img src=./pokemon_progress.png alt=progress>
<img src=./pokemon_play.png alt=play></p><p>I could play through the entire game of pokemon blue on an emulator that I had built from scratch using only documentation. I learned a lot about rust in the process, and it changed the way that I thought about the C++ memory model.</p><p>I was (and still am) very happy to have achieved this goal. My last commit in the project was:</p><blockquote><p>Add sync and prove emulator Pokemon-complete</p><p>Dream achieved. I undertook this project as I had extremely fond
memories of playing the original Pokemon games while growing up. With
this commit, enough of the emulator was implemented such that pokemon
blue can be played and completed (with only a few crashes! nothing that
some judicious save-gaming can&rsquo;t fix).
While there&rsquo;s still a <em>lot</em> of a full emulator to implement (gameboys
are much more complex than I anticipated), this was always my goal and I
don&rsquo;t feel like it&rsquo;s worth it to implement any more. I don&rsquo;t feel like
I&rsquo;d learn much more at this point.
I may do some basic rust cleanup at some point, and/or try to get it
running in webasm, but besides that, I&rsquo;m happy to call this one and move
on to other things.</p></blockquote></div></article></main><footer class=site-footer></footer></body></html>